<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRIMSON DESERT — 글로벌 피지컬 판매 순위</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">

<style>
body{background:#06050a;color:#f0ead8;font-family:'Noto Sans KR',sans-serif}
.wrap{max-width:1200px;margin:auto;padding:20px}
table{border-collapse:collapse;width:100%}
th,td{padding:10px;border:1px solid #333;text-align:center}
th{background:#111}
a{color:#4da3ff;text-decoration:none}
a:hover{text-decoration:underline}
.err{color:#ff5a5a}
.good{color:#3cff8f}
</style>
</head>

<body>
<div class="wrap">

<h1>CRIMSON DESERT — 글로벌 피지컬 판매 순위</h1>

<div>
<span id="statusTxt">데이터 로딩 중...</span>
<span id="updatedAt"></span>
<button onclick="loadData()">새로고침</button>
</div>

<hr>

<table>
<thead>
<tr>
<th>#</th>
<th>스토어</th>
<th>지역</th>
<th>PS5 순위</th>
<th>가격</th>
<th>상태</th>
</tr>
</thead>
<tbody id="rankBody">
<tr><td colspan="6">로딩 중...</td></tr>
</tbody>
</table>

</div>

<script>

let ALL=[];

function getBasePath(){
  const path = window.location.pathname;
  if(path.endsWith('/')) return path;
  return path.substring(0,path.lastIndexOf('/')+1);
}

async function loadData(){

  document.getElementById('statusTxt').textContent='데이터 로딩 중...';

  const base = getBasePath();
  const jsonUrl = base + 'data/latest.json';

  try{
    const resp = await fetch(jsonUrl,{cache:"no-store"});
    if(!resp.ok) throw "fail";
    ALL = await resp.json();
  }catch(e){
    document.getElementById('rankBody').innerHTML =
      '<tr><td colspan="6">데이터 없음</td></tr>';
    return;
  }

  renderTable();

  document.getElementById('statusTxt').textContent='라이브 데이터';
  document.getElementById('updatedAt').textContent=
    '업데이트: '+new Date().toLocaleTimeString('ko-KR');
}

function renderTable(){

  let sorted=[...ALL]
    .sort((a,b)=>(+a.rank_console||9999)-(+b.rank_console||9999));

  let html=sorted.map((r,i)=>{

    let status = r.error
      ? `<span class="err">${r.error}</span>`
      : `<span class="good">정상</span>`;

    let rank = r.rank_console ? `#${r.rank_console}` : '—';

    return `
      <tr>
        <td>${i+1}</td>
        <td>
          <a href="${r.store_url}" target="_blank">
            ${r.label}
          </a>
        </td>
        <td>${r.region}</td>
        <td>${rank}</td>
        <td>${r.price||'—'} ${r.currency||''}</td>
        <td>${status}</td>
      </tr>
    `;
  }).join('');

  document.getElementById('rankBody').innerHTML=html;
}

loadData();
setInterval(loadData,30*60*1000);

</script>

</body>
</html>
