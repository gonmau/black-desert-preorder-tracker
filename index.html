<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¶‰ì€ì‚¬ë§‰ â€” ê¸€ë¡œë²Œ í”¼ì§€ì»¬ íŒë§¤ ìˆœìœ„</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Noto+Sans+KR:wght@300;400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
/* ===== ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ìœ ì§€ ===== */
body{background:#06050a;color:#f0ead8;font-family:'Noto Sans KR',sans-serif}
.wrap{max-width:1200px;margin:auto;padding:20px}
.rbtn{cursor:pointer}
</style>
</head>

<body>
<div class="wrap">

<h1>CRIMSON DESERT â€” ê¸€ë¡œë²Œ í”¼ì§€ì»¬ íŒë§¤ ìˆœìœ„</h1>

<div>
<span id="statusTxt">ë°ì´í„° ë¡œë”© ì¤‘...</span>
<span id="updatedAt"></span>
<button class="rbtn" onclick="loadData()">ìƒˆë¡œê³ ì¹¨</button>
</div>

<hr>

<table border="1" width="100%" id="rankTable">
<thead>
<tr>
<th>#</th>
<th>ìŠ¤í† ì–´</th>
<th>ì§€ì—­</th>
<th>ì½˜ì†” ìˆœìœ„</th>
<th>ì¢…í•© ìˆœìœ„</th>
<th>ê°€ê²©</th>
</tr>
</thead>
<tbody id="rankBody">
<tr><td colspan="6">ë¡œë”© ì¤‘...</td></tr>
</tbody>
</table>

</div>

<script>
var ALL=[];

/* ğŸ”¥ GitHub Pages ì„œë¸Œê²½ë¡œ ì™„ì „ ëŒ€ì‘ */
function getBasePath(){
  const path = window.location.pathname;
  if(path.endsWith('/')) return path;
  return path.substring(0,path.lastIndexOf('/')+1);
}

/* ğŸ”¥ ìƒ˜í”Œ ìƒì„± */
function makeSample(){
  return [
    {store:"amazon_us",label:"ğŸ‡ºğŸ‡¸ Amazon US",region:"North America",rank_console:5,rank_overall:12,price:"69.99",currency:"USD"},
    {store:"amazon_jp",label:"ğŸ‡¯ğŸ‡µ Amazon JP",region:"Asia",rank_console:8,rank_overall:22,price:"9680",currency:"JPY"}
  ];
}

/* ğŸ”¥ ë°ì´í„° ë¡œë”© */
async function loadData(){
  document.getElementById('statusTxt').textContent='ë°ì´í„° ë¡œë”© ì¤‘...';

  const base = getBasePath();
  const jsonUrl = base + 'data/latest.json';
  const csvUrl  = base + 'data/rankings.csv';

  try{
    let resp = await fetch(jsonUrl,{cache:"no-store"});
    if(!resp.ok) throw "json fail";
    let j = await resp.json();
    ALL = j.results || [];
  }catch(e){
    try{
      let resp = await fetch(csvUrl,{cache:"no-store"});
      if(!resp.ok) throw "csv fail";
      let text = await resp.text();
      let parsed = Papa.parse(text,{header:true,skipEmptyLines:true});
      ALL = parsed.data;
    }catch(e2){
      ALL = makeSample();
    }
  }

  if(!ALL || !ALL.length){
    ALL = makeSample();
  }

  renderTable();

  document.getElementById('statusTxt').textContent='ë¼ì´ë¸Œ ë°ì´í„°';
  document.getElementById('updatedAt').textContent='ì—…ë°ì´íŠ¸: '+new Date().toLocaleTimeString('ko-KR');
}

/* ğŸ”¥ í…Œì´ë¸” ë Œë”ë§ */
function renderTable(){
  let sorted=[...ALL].sort((a,b)=>(+a.rank_console||999999)-(+b.rank_console||999999));
  let html=sorted.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${r.label}</td>
      <td>${r.region}</td>
      <td>#${r.rank_console||'â€”'}</td>
      <td>#${r.rank_overall||'â€”'}</td>
      <td>${r.price||'â€”'} ${r.currency||''}</td>
    </tr>
  `).join('');
  document.getElementById('rankBody').innerHTML=html;
}

loadData();
setInterval(loadData,30*60*1000);
</script>

</body>
</html>
